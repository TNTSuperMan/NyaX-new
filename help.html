<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NyaXヘルプ</title>
    <style>
        :root {
            --background-color: #f0f2f5;
            --chat-background: #ffffff;
            --user-bubble-color: #0084ff;
            --bot-bubble-color: #e4e6eb;
            --text-color-primary: #050505;
            --text-color-secondary: #ffffff;
            --text-color-bot: #050505;
            --border-color: #ced0d4;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        body {
            font-family: var(--font-family);
            margin: 0;
            background-color: var(--background-color);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 1rem;
            box-sizing: border-box;
        }
        #chat-container {
            width: 100%;
            max-width: 800px;
            height: 100%;
            max-height: 95vh;
            background-color: var(--chat-background);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }
        header h1 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--text-color-primary);
        }
        header p {
            margin: 0.25rem 0 0;
            color: #65676b;
        }
        #chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .message {
            display: flex;
            max-width: 85%;
        }
        .message-bubble {
            padding: 0.75rem 1rem;
            border-radius: 18px;
            line-height: 1.5;
            word-wrap: break-word;
        }
        .message-bubble a {
            color: #0056b3;
            text-decoration: underline;
        }
        .message-bubble a:hover {
            text-decoration: none;
        }
        .user {
            align-self: flex-end;
            margin-left: auto;
        }
        .user .message-bubble {
            background-color: var(--user-bubble-color);
            color: var(--text-color-secondary);
        }
        .bot {
            align-self: flex-start;
        }
        .bot .message-bubble {
            background-color: var(--bot-bubble-color);
            color: var(--text-color-bot);
        }
        .bot .message-bubble.streaming::after {
            content: '▍';
            animation: blink 1s infinite;
        }
        @keyframes blink {
            50% { opacity: 0; }
        }
        #chat-form {
            display: flex;
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            gap: 0.75rem;
        }
        #user-input {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 24px;
            font-size: 1rem;
            font-family: var(--font-family);
        }
        #user-input:focus {
            outline: none;
            border-color: var(--user-bubble-color);
            box-shadow: 0 0 0 2px rgba(0, 132, 255, 0.2);
        }
        #send-button {
            padding: 0.75rem 1.25rem;
            border: none;
            background-color: var(--user-bubble-color);
            color: white;
            border-radius: 24px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #send-button:hover {
            background-color: #0073e6;
        }
        #send-button:disabled {
            background-color: #a0d0ff;
            cursor: not-allowed;
        }
        .error-message {
            text-align: center;
            color: #d9534f;
            padding: 0.5rem;
        }
    </style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JYBQTQ1HCX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-JYBQTQ1HCX');
</script>
<body>

    <div id="chat-container">
        <header>
            <h1>NekoBot(β)</h1>
            <p>※AIは間違った回答を返すことがあります。十分注意してください</p>
        </header>
        <div id="chat-history">
            <!-- チャット履歴がここに追加されます -->
        </div>
        <form id="chat-form">
            <input type="text" id="user-input" placeholder="メッセージを入力..." autocomplete="off">
            <button type="submit" id="send-button">送信</button>
        </form>
    </div>

    <script type="module">
        // Google AI SDKをCDNからインポート
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        // ----- ▼▼▼ 設定項目 ▼▼▼ -----

        /**
         *【重要】ご自身のGemini APIキーに置き換えてください。
         * Google AI Studio (https://aistudio.google.com/app/apikey) で取得できます。
         */
        const API_KEY = "AIzaSyDghmwGaa75X_H4Tftpzx9lCQnb26IdTxM";

        /**
         * 使用するAIモデル名。
         */
        const MODEL_NAME = "gemini-2.5-flash-lite";

        /**
         * AIに与えるシステムプロンプト（役割設定）。
         */
        const SYSTEM_PROMPT = `# NyaX チャットボット システムプロンプト

> あなたは Scratcher 向けSNS「NyaX」のチャットボットです。ユーザーからの質問に対して、以下の情報とルールに基づき、親切かつ分かりやすく回答してください。

## あなたについて

- **名前:** NekoBot
- **役割:** NyaXの機能や使い方に関する質問に答えること
- **口調:** 親しみやすく丁寧な言葉遣い。**絵文字は絶対に使用しないこと**

---

## NyaXの基本情報

NyaX（にゃっくす）は、X (旧Twitter) のような使い心地を目指したシンプルなSNSです。Scratchのアカウントがあれば誰でも簡単に参加でき、文章・画像・動画などの投稿を通じて他のユーザーと繋がることができます。

---

## NyaXの主な機能

### アカウント・プロフィール関連

- **アカウント登録・ログイン**
    - Scratchアカウントで認証。特別なパスワード不要。Scratchプロジェクトに指定コードをコメントするだけで安全にログイン。
- **設定**
    - ユーザー名・自己紹介・アイコン画像を自由に設定可能（プロフィール画面ではなく設定から変更）。
- **公開設定**
    - 「いいね」「お気に入り」「フォローリスト」などの公開範囲を設定画面で細かく指定可能。

### 投稿（ポスト）関連

- **基本投稿**
    - 最大280文字のテキスト投稿。画像・動画・音声ファイルも添付可能。
- **リポスト**
    - 他人の投稿を自分のコメントなしでフォロワーに共有。
- **引用ポスト**
    - 他人の投稿に自分のコメントを付けて共有。
    - ※引用を返信代わりに使ったり、書き忘れた情報を引用で付け足す行為は避けるよう案内。
- **メンション・ハッシュタグ**
    - \`@ユーザーID\`で通知、\`#タグ\`で話題をグループ化。
- **独自絵文字**
    - \`_emoji_id_\`のようにアンダースコアでIDを囲むとNyaXオリジナル絵文字を表示。利用可能な絵文字は絵文字一覧ページ参照。
- **ポストの編集・削除**
    - 投稿後でも自分のポストを編集・削除可能。

### コミュニケーション機能

- **返信（リプライ）**
    - 他ユーザーの投稿に会話形式でコメント可能。
- **いいね**
    - 気に入った投稿にハートを送る最も手軽な反応方法。
- **お気に入り**
    - 後で読み返したい投稿を保存するブックマーク機能。
- **ダイレクトメッセージ（DM）**
    - 特定ユーザーやグループと非公開チャットが可能。

### 閲覧・検索機能

- **タイムライン**
    - **すべて:** 全ユーザーの投稿が時系列で流れる
    - **おすすめ:** 活動に基づき興味を持ちそうな投稿を自動選出
    - **フォロー中:** フォローしているユーザーの投稿のみ表示
- **プロフィール画面**
    - プロフィール情報と「ポスト」「返信」「メディア」「いいね」などのタブで活動をまとめて閲覧可能
- **検索**
    - キーワードで投稿やユーザーを高速検索
- **トレンド**
    - 「検索」ページで話題のハッシュタグをランキング形式で表示

---

## 重要：NyaXルール

> このルールは、NyaXを利用するすべてのユーザーが安全かつ快適に過ごせるように定められたものです。NyaXを利用することにより、あなたはこれらのルールに同意したものとみなされます。

### 基本方針

- 本ルールに違反した場合、運営は違反内容に応じて**該当ポストの削除**や**アカウントの凍結**といった措置を行います。
- ルールに明記されていない行為であっても、他のユーザーへの迷惑行為やサービスの安定運用を妨げる行為など、運営が不適切と判断した場合は措置の対象となることがあります。

### アカウントに関するルール

1. 複数アカウントの所持は、1人あたり**2つまで**を上限とします。
2. 所持しているアカウントのいずれかが凍結された場合、凍結を回避する目的で別のアカウントを使用してサービスを利用することは**禁止します**。
3. NyaXアカウントを第三者へ譲渡、売買、貸与することは**禁止します**。

### ポストに関するルール

1. スパム行為や、自動化された手段による大量投稿など、サーバーに過度な負荷をかける行為は**禁止します**。
2. 攻撃的な表現や、他者が不快に感じる可能性のある発言は控えてください。
3. 特定の個人や団体に対する誹謗中傷、嫌がらせ、脅迫といった行為は控えてください。
4. ルールに違反するポストを発見した場合は、[NyaX色々申請フォーム](https://forms.gle/buZpMftRNWjfhqVz8)で報告してください。

### ダイレクトメッセージに関するルール

1. ダイレクトメッセージの内容は、プライバシー保護のため運営が通常閲覧することはありません。ただし、利用者からルール違反の通報があった場合に限り、内容を確認することがあります。
2. メッセージ機能を利用した、特定の個人に対する誹謗中傷、嫌がらせ、脅迫を**禁止します**。
3. 相手の迷惑となるような、一方的なメッセージの連続送信（連投）は控えてください。
4. メッセージでルール違反の行為を受けた場合は、[NyaX色々申請フォーム](https://forms.gle/buZpMftRNWjfhqVz8)で報告してください。

### 金銭に関するルール

1. NyaX上での金銭のやり取りは特に規制しませんが、常識的な行動を心がけましょう。
2. 金銭等のトラブルについてNyaXは**一切の責任を負いません**。

### NyaXのURLに関するルール

- ScratchやXなどの不特定多数が閲覧できる場所にNyaXのURLを貼ることを**禁止します**(既存のURLに関しては9月まで削除期間を設けます)

---

## NyaXの各URLと説明

| URL      | 説明                                                         |
|----------|--------------------------------------------------------------|
| \`/\`      | NyaXのメイン画面。基本的な操作は全てここで行います           |
| \`/emoji\` | NyaXで利用できるEmojiを一覧表示                              |
| \`/stat\`  | NyaXの統計を確認                                             |
| \`/ranking\` | フォロワー数・ポスト数・いいね数・お気に入り数のランキング |
| \`/help\`  | NekoBotに質問できるページ                                    |

---

## NyaXの利用者制限

認証に使用したScratchアカウントが**以下の全てを満たさない場合ブロックされます**：
1. NewScratcherではなくScratcherになっている
2. 正規のフォロワーが25人以上

また、NyaXは海外やVPN経由でのアクセスをブロックします。

---

## 個人情報について

NyaXはログイン時に以下の情報を記録します：
1. 認証した日付
2. 認証に使用したScratchのユーザー名
3. IPアドレス

> 上記の個人情報は公開しません。ただし、凍結時のみNyaXTeam（運営）が確認する権限を持ちます。
> 保存情報の確認を希望する場合は管理者にDMで連絡してください。
> DMはNyaXTeamは確認できませんが、管理者は通報時のみ確認します。

---

## 応答のガイドライン

- 上記の機能やルールについて質問されたら、該当する説明を元に回答してください。
- リストにない質問や技術的な詳細については「ごめんなさい、その質問には詳しくお答えできません。開発者にお問い合わせください。」と回答してください。
- 常にユーザーフレンドリーな対応を心がけてください。`;

        // ----- ▲▲▲ 設定項目ここまで ▲▲▲ -----

        // --- DOM要素の取得 ---
        const chatHistory = document.getElementById('chat-history');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');

        let chat;

        // --- 初期化処理 ---
        function initializeChat() {
            try {
                const genAI = new GoogleGenerativeAI(API_KEY);
                const model = genAI.getGenerativeModel({
                    model: MODEL_NAME,
                    systemInstruction: SYSTEM_PROMPT,
                });
                const generationConfig = {
                    temperature: 0, // Temperatureを0に設定
                    // 他の設定が必要な場合はここに追加
                };
                chat = model.startChat({
                    generationConfig,
                    history: [],
                });

            } catch (error) {
                console.error("AIの初期化に失敗:", error);
                addMessageToUI(`<strong>エラー:</strong> AIの初期化に失敗しました。APIキーやモデル名が正しいか確認してください。<br><small>${error.message}</small>`, "bot", true);
                sendButton.disabled = true;
                userInput.disabled = true;
            }
        }

        /**
         * 応答テキスト内の特定のパスをリンクに変換する
         * @param {string} text - 変換するテキスト
         * @returns {string} - 変換後のHTML文字列
         */
        function formatResponse(text) {
            const pageLinks = {
                "/": "NyaX",
                "/emoji": "絵文字一覧",
                "/stat": "統計",
                "/ranking": "ランキング",
                "/help": "ヘルプ"
            };
            
            // HTMLエスケープを先に行い、意図しないタグが生成されるのを防ぐ
            // ただし、改行は<br>にしたいので一旦プレースホルダーに
            const newlinePlaceholder = "%%NEWLINE%%";
            let escapedText = text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, '&quot;')
                .replace(/'/g, "&#39;")
                .replace(/\n/g, newlinePlaceholder);

            // pageLinksの各パスを対応する<a>タグに置換
            for (const [path, name] of Object.entries(pageLinks)) {
                const linkHtml = `<a href="${path}" target="_blank" rel="noopener noreferrer">${name}</a>`;
                // String.prototype.replaceAll を使って、全ての出現箇所を置換
                escapedText = escapedText.replaceAll(path, linkHtml);
            }

            // 最後に改行のプレースホルダーを<br>に戻す
            return escapedText.replaceAll(newlinePlaceholder, '<br>');
        }

        /**
         * チャット履歴にメッセージを追加する
         * @param {string} text - メッセージ内容 (HTML可)
         * @param {'user' | 'bot'} sender - 送信者
         * @param {boolean} isError - エラーメッセージかどうか
         * @returns {HTMLElement} - 追加されたメッセージのDOM要素
         */
        function addMessageToUI(text, sender, isError = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            if (isError) {
                bubbleDiv.classList.add('error-message');
            }
            bubbleDiv.innerHTML = text;

            messageDiv.appendChild(bubbleDiv);
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight; // 自動スクロール
            return bubbleDiv;
        }

        // --- フォーム送信時の処理 ---
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const prompt = userInput.value.trim();
            if (!prompt) return;

            userInput.value = '';
            sendButton.disabled = true;
            addMessageToUI(prompt, 'user');

            const botBubble = addMessageToUI('', 'bot');
            botBubble.classList.add('streaming');

            try {
                const result = await chat.sendMessageStream(prompt);
                let responseText = "";
                for await (const chunk of result.stream) {
                    responseText += chunk.text();
                    botBubble.innerHTML = formatResponse(responseText);
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                }

            } catch (error) {
                console.error("AIからの応答取得に失敗:", error);
                botBubble.innerHTML = `<strong>エラー:</strong> メッセージの送信に失敗しました。<br><small>${error.message}</small>`;
                botBubble.classList.add('error-message');
            } finally {
                botBubble.classList.remove('streaming');
                sendButton.disabled = false;
                userInput.focus();
            }
        });

        // --- 初期化実行 ---
        initializeChat();
    </script>
</body>
</html>
